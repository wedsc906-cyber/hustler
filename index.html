<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Betting Pool</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --bg:#0f172a; --panel:#020617; --border:#334155;
  --text:#e5e7eb; --muted:#94a3b8; --primary:#2563eb; --danger:#dc2626;
}

body {
  font-family: Inter, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: 20px;
}

.card {
  background: var(--panel);
  padding: 16px;
  border-radius: 12px;
  margin-top: 18px;
}

.controls {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

input, select, button {
  background: #020617;
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px;
  border-radius: 8px;
}

button { font-weight: 600; cursor: pointer; }
.btn-primary { background:#2563eb; color:white; }
.btn-secondary { background:#020617; border:1px solid var(--border); color:white; }
.btn-danger { background:#dc2626; color:white; }

table {
  width:100%;
  border-collapse: collapse;
  margin-top:10px;
}

th, td {
  padding:10px;
  border-bottom:1px solid var(--border);
  text-align:center;
}

.place-btn {
  background:#020617;
  border:1px solid var(--border);
  color:white;
  border-radius:8px;
  padding: 6px 10px;
  margin: 2px;
}
.place-btn.active { background:#2563eb; }

.total { margin-top:6px; color:#94a3b8; }

.expand-btn {
  cursor: pointer;
  user-select: none;
  color: #94a3b8;
  margin-right: 6px;
  display: inline-block;
  transition: transform 0.15s ease;
}

.expand-btn.open {
  transform: rotate(90deg);
}

.details-row {
  display: none;
  background: #020617;
}

.details-cell {
  text-align: left;
  padding: 12px 16px;
  color: #cbd5f5;
}

.remove-bet {
  margin-left: 8px;
  background: transparent;
  border: none;
  color: #f87171;
  cursor: pointer;
  font-size: 14px;
}

.column-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

.column-tab {
  background: #020617;
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
}

.column-tab:hover {
  border-color: #2563eb;
}

.column-tab.active {
  background: #2563eb;
  border-color: #2563eb;
}

.column-tab .remove-column {
  margin-left: 8px;
  color: #f87171;
  font-size: 12px;
}

.popout h1,
.popout .hide-in-popout,
.popout .place-col,
.popout .buyin-col {
  display: none !important;
}

.popout body {
  padding: 10px;
}

.popout table {
  font-size: 18px;
}

.popout .card .total {
  display: none;
}

.popout .card {
  transform-origin: top center;
}
</style>
</head>

<body>

<h1>Live Betting Pool</h1>

<div class="card hide-in-popout">
  <h3>Spalten verwalten</h3>
  <div class="controls">
    <input id="newColumnName" placeholder="Neue Spalte (z.B. Runde 1)">
    <button class="btn-primary" onclick="addColumn()">+ Spalte</button>
  </div>
</div>

<div class="card hide-in-popout">
  <h3>Add Contestant</h3>
  <div class="controls">
    <select id="columnSelectContestant"></select>
    <input id="contestantName" placeholder="Contestant name (Enter to add)">
    <input id="contestantBuyIn" placeholder="Buy-in (1k, 1m)">
    <button class="btn-primary" onclick="addContestant()">Add</button>
  </div>
</div>

<div class="card hide-in-popout">
  <h3>Place Bet</h3>
  <div class="controls">
    <select id="columnSelectBet"></select>
    <input id="bettorName" placeholder="Bettor name (Enter to bet)">
    <select id="contestantSelect"></select>
    <input id="betAmount" placeholder="Amount (1k, 1m)">
    <button class="btn-primary" onclick="placeBet()">Bet</button>
  </div>
</div>

<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h3 id="overviewTitle">Overview</h3>
    <div class="hide-in-popout">
      <button class="btn-secondary" onclick="openPopout()">üì∫ Pop-out</button>
      <button class="btn-secondary" onclick="exportData()">üíæ Export</button>
      <button class="btn-secondary" onclick="importData()">üìÇ Import</button>
      <button class="btn-danger" onclick="resetWithPassword()">Reset</button>
    </div>
  </div>

  <div class="column-tabs" id="columnTabs"></div>

  <table>
    <thead>
      <tr>
        <th>Contestant</th>
        <th>Total</th>
        <th>Mult</th>
        <th class="buyin-col">Buy-In</th>
        <th class="place-col">Place</th>
      </tr>
    </thead>
    <tbody id="contestantTable"></tbody>
  </table>

  <div class="total">Pot: <span id="totalPot">$0</span></div>
  <div class="total">House: <span id="houseCut">$0</span></div>
  <div class="total">Payout: <span id="payoutPool">$0</span></div>
</div>

<div class="card hide-in-popout">
  <h3>Buy-In Prize Pool</h3>
  <div>Total Buy-Ins: <span id="buyInTotal">$0</span></div>
  <div>Prize Pool: <span id="buyInPrize">$0</span></div>
  <hr>
  <div>ü•á <span id="firstName">‚Äî</span>: <span id="firstPrize">$0</span></div>
  <div>ü•à <span id="secondName">‚Äî</span>: <span id="secondPrize">$0</span></div>
  <div>ü•â <span id="thirdName">‚Äî</span>: <span id="thirdPrize">$0</span></div>
</div>

<input type="file" id="importFile" style="display:none" accept=".json">

<script>
/* ================= POP-OUT DETECTION ================= */
const isPopout = new URLSearchParams(location.search).has("popout");
if (isPopout) document.documentElement.classList.add("popout");

/* ================= CONFIG ================= */
const ADMIN_PASSWORD = "reset123";
const BET_HOUSE = 0.15;
const BUYIN_HOUSE = 0.10;
const STORAGE_KEY = 'betting_pool_state';

/* ================= STATE ================= */
let state = {
  columns: { 
    "Default": { 
      contestants: {}, 
      totalPot: 0, 
      placements: { first:null, second:null, third:null } 
    } 
  },
  activeColumn: "Default"
};

/* ================= HELPERS ================= */
const parseAmount = v => {
  if (!v) return 0;
  const val = v.toLowerCase().trim();
  if (val.endsWith("m")) return parseFloat(val) * 1_000_000;
  if (val.endsWith("k")) return parseFloat(val) * 1_000;
  return parseFloat(val);
};

const fmt = v => `$${(v||0).toLocaleString()}`;
const fmtPayout = v => `$${Math.floor(v||0).toLocaleString()}`;

const getActiveColumnData = () => state.columns[state.activeColumn] || { 
  contestants: {}, 
  totalPot: 0, 
  placements: { first:null, second:null, third:null } 
};

/* ================= LOCAL STORAGE ================= */
function saveState() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    broadcastUpdate();
  } catch (e) {
    console.error('Failed to save state:', e);
  }
  render();
}

function loadState() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      state = JSON.parse(saved);
    }
  } catch (e) {
    console.error('Failed to load state:', e);
  }
  render();
}

/* ================= BROADCAST CHANNEL (sync between tabs) ================= */
const bc = new BroadcastChannel('betting_pool');

bc.onmessage = (event) => {
  if (event.data.type === 'state_update') {
    state = event.data.state;
    render();
  }
};

function broadcastUpdate() {
  bc.postMessage({ type: 'state_update', state: state });
}

/* ================= EXPORT/IMPORT ================= */
function exportData() {
  const dataStr = JSON.stringify(state, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `betting_pool_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importData() {
  importFile.click();
}

importFile.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const imported = JSON.parse(event.target.result);
      if (imported.columns && imported.activeColumn) {
        state = imported;
        saveState();
        alert('‚úÖ Daten erfolgreich importiert!');
      } else {
        alert('‚ùå Ung√ºltiges Dateiformat!');
      }
    } catch (e) {
      alert('‚ùå Fehler beim Importieren: ' + e.message);
    }
  };
  reader.readAsText(file);
  e.target.value = '';
});

/* ================= COLUMN ACTIONS ================= */
function addColumn(){
  const name = newColumnName.value.trim();
  if(!name || state.columns[name]) return;
  state.columns[name] = { 
    contestants: {}, 
    totalPot: 0, 
    placements: { first:null, second:null, third:null } 
  };
  newColumnName.value = "";
  saveState();
}

function setActiveColumn(name){
  state.activeColumn = name;
  saveState();
}

function removeColumn(name){
  if(Object.keys(state.columns).length <= 1) {
    alert("Mindestens eine Spalte muss bleiben!");
    return;
  }
  if(!confirm(`Spalte "${name}" wirklich l√∂schen?`)) return;
  delete state.columns[name];
  if(state.activeColumn === name) {
    state.activeColumn = Object.keys(state.columns)[0];
  }
  saveState();
}

/* ================= ACTIONS ================= */
function addContestant(){
  const colName = columnSelectContestant.value;
  const n = contestantName.value.trim();
  if(!n || !colName || state.columns[colName].contestants[n]) return;
  
  state.columns[colName].contestants[n] = { 
    total:0, 
    bets:[], 
    buyIn: parseAmount(contestantBuyIn.value) || 0 
  };
  
  contestantName.value=""; 
  contestantBuyIn.value="";
  saveState();
}

function placeBet(){
  const colName = columnSelectBet.value;
  const c = contestantSelect.value;
  const amt = parseAmount(betAmount.value);
  const bettor = bettorName.value.trim();
  
  if(!c || !amt || !bettor || !colName) return;

  const col = state.columns[colName];
  col.contestants[c].total += amt;
  col.totalPot += amt;
  col.contestants[c].bets.push({ name: bettor, amount: amt });

  bettorName.value=""; 
  betAmount.value="";
  saveState();
}

function removeBet(colName, contestant, index){
  const col = state.columns[colName];
  const bet = col.contestants[contestant].bets[index];
  if(!bet) return;

  col.contestants[contestant].total -= bet.amount;
  col.totalPot -= bet.amount;
  col.contestants[contestant].bets.splice(index,1);
  saveState();
}

function setPlacement(p,n){
  const col = getActiveColumnData();
  Object.keys(col.placements).forEach(k=>{
    if(col.placements[k]===n) col.placements[k]=null;
  });
  col.placements[p]=n;
  saveState();
}

function resetWithPassword(){
  if(prompt("Admin password")!==ADMIN_PASSWORD) return;
  
  state = { 
    columns: { 
      "Default": { 
        contestants: {}, 
        totalPot: 0, 
        placements: { first:null, second:null, third:null } 
      } 
    }, 
    activeColumn: "Default" 
  };
  
  saveState();
}

function openPopout(){
  window.open(location.pathname+"?popout=1","pop","width=900,height=600");
}

/* ================= EXPAND ================= */
function toggleRow(id, btn){
  const row = document.getElementById(id);
  const open = row.style.display === "table-row";
  row.style.display = open ? "none" : "table-row";
  btn.classList.toggle("open", !open);
}

function scalePopoutToFit(){
  if(!isPopout) return;

  const card = document.querySelector(".card");
  if(!card) return;

  card.style.transform = "scale(1)";

  const available = window.innerHeight - 20;
  const height = card.scrollHeight;

  if(height > available){
    card.style.transform = `scale(${available / height})`;
  }
}

/* ================= RENDER ================= */
function render(){
  const col = getActiveColumnData();

  // Column tabs
  columnTabs.innerHTML = Object.keys(state.columns).map(name => {
    const isActive = name === state.activeColumn;
    const canRemove = Object.keys(state.columns).length > 1;
    return `
      <div class="column-tab ${isActive?'active':''}" onclick="setActiveColumn('${name}')">
        ${name}
        ${canRemove && !isPopout ? `<span class="remove-column" onclick="event.stopPropagation(); removeColumn('${name}')">‚úï</span>` : ''}
      </div>
    `;
  }).join("");

  // Column selects
  const columnOptions = Object.keys(state.columns).map(n=>
    `<option ${n===state.activeColumn?'selected':''}>${n}</option>`
  ).join("");
  columnSelectContestant.innerHTML = columnOptions;
  columnSelectBet.innerHTML = columnOptions;

  // Contestant select
  contestantSelect.innerHTML = Object.keys(col.contestants)
    .map(n=>`<option>${n}</option>`)
    .join("");

  // Contestant table
  contestantTable.innerHTML="";
  const payout = col.totalPot*(1-BET_HOUSE);
  let buyTotal=0;

  const sortedContestants = Object.entries(col.contestants)
    .sort((a,b) => (b[1].total || 0) - (a[1].total || 0));

  for(const [n,c] of sortedContestants){
    buyTotal+=c.buyIn;
    const mult=c.total?payout/c.total:0;
    const rowId="details_"+n.replace(/\W/g,"_");

    const betsHtml = c.bets.length
      ? c.bets.map((b,i)=>{
          const betPayout = b.amount * mult;
          return `
          <div>
            üë§ ${b.name} ‚Äî ${fmt(b.amount)}
            <span style="color: #22c55e; font-weight: 600;">‚Üí ${fmtPayout(betPayout)}</span>
            <button class="remove-bet" onclick="removeBet('${state.activeColumn}','${n}',${i})">üóë</button>
          </div>
        `;
        }).join("")
      : "<div>No bets</div>";

    contestantTable.innerHTML+=`
      <tr>
        <td><span class="expand-btn" onclick="toggleRow('${rowId}',this)">‚ñ∂</span>${n}</td>
        <td>${fmt(c.total)}</td>
        <td>${mult?mult.toFixed(2)+'x':'‚Äî'}</td>
        <td class="buyin-col">${fmt(c.buyIn)}</td>
        <td class="place-col">
          <button class="place-btn ${col.placements.first===n?'active':''}" onclick="setPlacement('first','${n}')">ü•á</button>
          <button class="place-btn ${col.placements.second===n?'active':''}" onclick="setPlacement('second','${n}')">ü•à</button>
          <button class="place-btn ${col.placements.third===n?'active':''}" onclick="setPlacement('third','${n}')">ü•â</button>
        </td>
      </tr>
      <tr id="${rowId}" class="details-row">
        <td colspan="5" class="details-cell">${betsHtml}</td>
      </tr>
    `;
  }

  // Summary
  totalPot.textContent=fmt(col.totalPot);
  houseCut.textContent=fmt(col.totalPot*BET_HOUSE);
  payoutPool.textContent=fmt(payout);

  // Buy-in prizes
  const prize=buyTotal*(1-BUYIN_HOUSE);
  buyInTotal.textContent=fmt(buyTotal);
  buyInPrize.textContent=fmt(prize);

  firstName.textContent=col.placements.first||"‚Äî";
  secondName.textContent=col.placements.second||"‚Äî";
  thirdName.textContent=col.placements.third||"‚Äî";
  firstPrize.textContent=fmt(prize*0.5);
  secondPrize.textContent=fmt(prize*0.3);
  thirdPrize.textContent=fmt(prize*0.2);

  if (isPopout) {
    overviewTitle.textContent = `${state.activeColumn} ‚Äî Pot: ${fmt(col.totalPot)}`;
  }

  scalePopoutToFit();
}

/* ================= ENTER KEY SHORTCUTS ================= */
newColumnName.addEventListener("keydown", e => e.key==="Enter" && addColumn());
contestantName.addEventListener("keydown", e => e.key==="Enter" && addContestant());
contestantBuyIn.addEventListener("keydown", e => e.key==="Enter" && addContestant());
bettorName.addEventListener("keydown", e => e.key==="Enter" && placeBet());
betAmount.addEventListener("keydown", e => e.key==="Enter" && placeBet());

/* ================= INIT ================= */
loadState();
</script>

</body>
</html>
