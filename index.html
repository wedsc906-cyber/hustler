<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Betting Pool</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --bg:#0f172a; --panel:#020617; --border:#334155;
  --text:#e5e7eb; --muted:#94a3b8; --primary:#2563eb; --danger:#dc2626;
}

body {
  font-family: Inter, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: 20px;
}

.card {
  background: var(--panel);
  padding: 16px;
  border-radius: 12px;
  margin-top: 18px;
}

.controls {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

input, select, button {
  background: #020617;
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px;
  border-radius: 8px;
}

button { font-weight: 600; cursor: pointer; }
.btn-primary { background:#2563eb; color:white; }
.btn-secondary { background:#020617; border:1px solid var(--border); color:white; }
.btn-danger { background:#dc2626; color:white; }

table {
  width:100%;
  border-collapse: collapse;
  margin-top:10px;
}

th, td {
  padding:10px;
  border-bottom:1px solid var(--border);
  text-align:center;
}

.place-btn {
  background:#020617;
  border:1px solid var(--border);
  color:white;
  border-radius:8px;
}
.place-btn.active { background:#2563eb; }

.total { margin-top:6px; color:#94a3b8; }

/* ===== EXPAND ROW ===== */
.expand-btn {
  cursor: pointer;
  user-select: none;
  color: #94a3b8;
  margin-right: 6px;
  display: inline-block;
  transition: transform 0.15s ease;
}
.expand-btn.open { transform: rotate(90deg); }

.details-row { display:none; background:#020617; }
.details-cell { text-align:left; padding:12px 16px; color:#cbd5f5; }

/* ===== POP-OUT ===== */
.popout h1,
.popout .hide-in-popout,
.popout .place-col,
.popout .buyin-col {
  display:none !important;
}
</style>
</head>

<body>

<h1>Live Betting Pool</h1>

<div class="card hide-in-popout">
  <h3>Add Contestant</h3>
  <div class="controls">
    <input id="contestantName" placeholder="Contestant name (Enter to add)">
    <input id="contestantBuyIn" placeholder="Buy-in (1k, 1m)">
    <button class="btn-primary" onclick="addContestant()">Add</button>
  </div>
</div>

<div class="card hide-in-popout">
  <h3>Place Bet</h3>
  <div class="controls">
    <input id="bettorName" placeholder="Bettor name (Enter to bet)">
    <select id="contestantSelect"></select>
    <input id="betAmount" placeholder="Amount (1k, 1m)">
    <button class="btn-primary" onclick="placeBet()">Bet</button>
  </div>
</div>

<div class="card">
  <h3>Overview</h3>
  <table>
    <thead>
      <tr>
        <th>Contestant</th>
        <th>Total</th>
        <th>Mult</th>
        <th class="buyin-col">Buy-In</th>
        <th class="place-col">Place</th>
      </tr>
    </thead>
    <tbody id="contestantTable"></tbody>
  </table>

  <div class="total">Pot: <span id="totalPot">$0</span></div>
  <div class="total">House: <span id="houseCut">$0</span></div>
  <div class="total">Payout: <span id="payoutPool">$0</span></div>
</div>

<script>
const BET_HOUSE = 0.15;
let state = { contestants:{}, totalPot:0, placements:{} };

const parseAmount=v=>{
  if(!v) return 0;
  v=v.toLowerCase();
  if(v.endsWith("m")) return parseFloat(v)*1e6;
  if(v.endsWith("k")) return parseFloat(v)*1e3;
  return parseFloat(v);
};
const fmt=v=>`$${(v||0).toLocaleString()}`;

/* ===== ADD CONTESTANT ===== */
function addContestant(){
  const n = contestantName.value.trim();
  if(!n || state.contestants[n]) return;

  state.contestants[n] = { total:0, buyIn:parseAmount(contestantBuyIn.value)||0, bets:[] };

  contestantName.value="";
  contestantBuyIn.value="";
  contestantName.focus();
  render();
}

/* ===== PLACE BET ===== */
function placeBet(){
  const c = contestantSelect.value;
  const amt = parseAmount(betAmount.value);
  const bettor = bettorName.value.trim();
  if(!c || !amt || !bettor) return;

  state.contestants[c].total += amt;
  state.totalPot += amt;
  state.contestants[c].bets.push({ name:bettor, amount:amt });

  bettorName.value="";
  betAmount.value="";
  bettorName.focus();
  render();
}

/* ===== ENTER KEY SUPPORT ===== */
["contestantName","contestantBuyIn"].forEach(id=>{
  document.getElementById(id).addEventListener("keydown",e=>{
    if(e.key==="Enter"){ e.preventDefault(); addContestant(); }
  });
});

["bettorName","betAmount"].forEach(id=>{
  document.getElementById(id).addEventListener("keydown",e=>{
    if(e.key==="Enter"){ e.preventDefault(); placeBet(); }
  });
});

/* ===== EXPAND ===== */
function toggleRow(id,btn){
  const r=document.getElementById(id);
  const open=r.style.display==="table-row";
  r.style.display=open?"none":"table-row";
  btn.classList.toggle("open",!open);
}

/* ===== RENDER ===== */
function render(){
  contestantSelect.innerHTML = Object.keys(state.contestants)
    .map(n=>`<option>${n}</option>`).join("");

  contestantTable.innerHTML="";
  const payout = state.totalPot*(1-BET_HOUSE);

  for(const [n,c] of Object.entries(state.contestants)){
    const mult = c.total ? payout/c.total : 0;
    const id = "d_"+n.replace(/\W/g,"");

    const bets = c.bets.map(b=>{
      const win = b.amount*mult;
      return `<div>ðŸ‘¤ ${b.name} â€” ${fmt(b.amount)} â†’ <strong>${fmt(win)}</strong></div>`;
    }).join("") || "No bets";

    contestantTable.innerHTML+=`
      <tr>
        <td><span class="expand-btn" onclick="toggleRow('${id}',this)">â–¶</span>${n}</td>
        <td>${fmt(c.total)}</td>
        <td>${mult?mult.toFixed(2)+"x":"â€”"}</td>
        <td class="buyin-col">${fmt(c.buyIn)}</td>
        <td class="place-col">â€”</td>
      </tr>
      <tr id="${id}" class="details-row">
        <td colspan="5" class="details-cell">${bets}</td>
      </tr>
    `;
  }

  totalPot.textContent=fmt(state.totalPot);
  houseCut.textContent=fmt(state.totalPot*BET_HOUSE);
  payoutPool.textContent=fmt(payout);
}

render();
</script>

</body>
</html>
