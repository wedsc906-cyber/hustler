<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Live Betting Pool</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { background:#0f172a; color:#e5e7eb; font-family:Arial; padding:20px }
.card { background:#020617; padding:16px; border-radius:12px; margin-top:16px }
input, select, button {
  padding:8px; border-radius:8px;
  background:#020617; color:white; border:1px solid #334155
}
button { cursor:pointer }
table { width:100%; margin-top:10px; border-collapse:collapse }
th,td { padding:8px; border-bottom:1px solid #334155; text-align:center }
.hidden { display:none }
</style>
</head>

<body>

<h1 id="title">Live Betting Pool</h1>

<div id="admin">

<div class="card">
  <h3>Add Contestant</h3>
  <input id="contestantName" placeholder="Name">
  <button onclick="addContestant()">Add</button>
</div>

<div class="card">
  <h3>Place Bet</h3>
  <input id="bettorName" placeholder="Bettor">
  <select id="contestantSelect"></select>
  <input id="betAmount" placeholder="Amount (100)">
  <button onclick="placeBet()">Bet</button>
</div>

<button onclick="openPopout()">ðŸ“º Pop-out</button>
<button onclick="reset()">Reset</button>

</div>

<div class="card">
<table>
<thead>
<tr><th>Contestant</th><th>Total</th><th>Mult</th></tr>
</thead>
<tbody id="table"></tbody>
</table>
</div>

<script>
/* ===== MODE ===== */
const IS_POPOUT = new URLSearchParams(location.search).has("popout");

/* ===== SUPABASE ===== */
const SUPABASE_URL = "https://ctirstrnatawigarrncc.supabase.co";
const SUPABASE_KEY = "sb_publishable_GdaFQ6Vn9HT-U9tg7iX8yw_810IiIXK";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== STATE ===== */
let state = { contestants:{}, total:0 };

/* ===== LOAD / SAVE ===== */
async function loadState(){
  const { data } = await supabase
    .from("state")
    .select("data")
    .eq("id",1)
    .single();

  if(data?.data) state = data.data;
  render();
}

async function saveState(){
  await supabase
    .from("state")
    .update({ data: state })
    .eq("id",1);
}

/* ===== REALTIME ===== */
supabase.channel("state")
.on("postgres_changes",{event:"UPDATE",table:"state"},payload=>{
  state = payload.new.data;
  render();
})
.subscribe();

/* ===== ACTIONS ===== */
function addContestant(){
  const name = contestantName.value.trim();
  if(!name || state.contestants[name]) return;
  state.contestants[name] = 0;
  contestantName.value = "";
  saveState();
}

function placeBet(){
  const name = contestantSelect.value;
  const amt = parseFloat(betAmount.value);
  if(!name || !amt) return;
  state.contestants[name] += amt;
  state.total += amt;
  betAmount.value = "";
  saveState();
}

function reset(){
  state = { contestants:{}, total:0 };
  saveState();
}

function openPopout(){
  window.open("?popout=1","pop","width=600,height=400");
}

/* ===== RENDER ===== */
function render(){
  table.innerHTML = "";
  contestantSelect.innerHTML = "";

  const payout = state.total * 0.85;

  for(const name in state.contestants){
    const total = state.contestants[name];
    const mult = total ? (payout / total).toFixed(2) : "â€”";

    table.innerHTML += `
      <tr>
        <td>${name}</td>
        <td>$${total}</td>
        <td>${mult}x</td>
      </tr>`;

    if(!IS_POPOUT){
      contestantSelect.innerHTML += `<option>${name}</option>`;
    }
  }
}

/* ===== ENTER KEY ===== */
contestantName.onkeydown = e => e.key==="Enter" && addContestant();
betAmount.onkeydown = e => e.key==="Enter" && placeBet();

/* ===== POPOUT MODE ===== */
if(IS_POPOUT){
  document.getElementById("admin").classList.add("hidden");
  document.getElementById("title").innerText = "Live Betting Display";
}

/* ===== INIT ===== */
loadState();
</script>

</body>
</html>
