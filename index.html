<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Betting Pool</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --bg:#0f172a; --panel:#020617; --border:#334155;
  --text:#e5e7eb; --muted:#94a3b8; --primary:#2563eb;
}

body {
  font-family: Inter, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: 20px;
}

.card {
  background: var(--panel);
  padding: 16px;
  border-radius: 12px;
  margin-top: 18px;
}

.controls {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

input, select, button {
  background: #020617;
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px;
  border-radius: 8px;
}

button { font-weight: 600; cursor: pointer; }

.btn-primary { background:#2563eb; color:white; }

table {
  width:100%;
  border-collapse: collapse;
  margin-top:10px;
}

th, td {
  padding:10px;
  border-bottom:1px solid var(--border);
  text-align:center;
}

tr.clickable { cursor:pointer; }

tr.details td {
  text-align:left;
  font-size:0.85rem;
  line-height:1.6;
  color:#c7d2fe;
}

.total { margin-top:6px; color:#94a3b8; }

.popout-hide { display:none !important; }
</style>
</head>

<body>

<h1 id="pageTitle">Live Betting Pool</h1>

<div class="card" id="addContestantCard">
  <h3>Add Contestant</h3>
  <div class="controls">
    <input id="contestantName" placeholder="Contestant name">
    <input id="contestantBuyIn" placeholder="Buy-in (1k)">
    <button class="btn-primary" onclick="addContestant()">Add</button>
  </div>
</div>

<div class="card" id="placeBetCard">
  <h3>Place Bet</h3>
  <div class="controls">
    <input id="bettorName" placeholder="Bettor name">
    <select id="contestantSelect"></select>
    <input id="betAmount" placeholder="Amount (1k)">
    <button class="btn-primary" onclick="placeBet()">Bet</button>
  </div>
</div>

<div class="card">
  <h3 id="overviewTitle">Overview</h3>

  <table>
    <thead>
      <tr>
        <th>Contestant</th>
        <th>Total</th>
        <th>Mult</th>
        <th class="buyin-col">Buy-In</th>
      </tr>
    </thead>
    <tbody id="contestantTable"></tbody>
  </table>

  <div class="total" id="totalsBlock">
    Total Pot: <span id="totalPot">$0</span><br>
    House: <span id="houseCut">$0</span><br>
    Payout Pool: <span id="payoutPool">$0</span>
  </div>
</div>

<script>
/* ================= MODE ================= */
const IS_POPOUT = new URLSearchParams(window.location.search).has("popout");

/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://ctirstrnatawigarrncc.supabase.co";
const SUPABASE_KEY = "sb_publishable_GdaFQ6Vn9HT-U9tg7iX8yw_810IiIXK";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= CONFIG ================= */
const BET_HOUSE = 0.15;

/* ================= STATE ================= */
let state = { contestants:{}, totalPot:0 };
let expandedContestant = null;

/* ================= HELPERS ================= */
function parseAmount(v){
  if(!v) return NaN;
  v=v.toLowerCase().trim();
  if(v.endsWith("k")) return parseFloat(v)*1000;
  return parseFloat(v);
}
const fmt=v=>`$${(v||0).toLocaleString()}`;

/* ================= DATABASE ================= */
async function saveState(){
  await supabaseClient.from("state").upsert({id:1,data:state});
}

async function loadState(){
  const {data}=await supabaseClient.from("state").select("data").eq("id",1).single();
  if(data?.data) state=data.data;
  render(true);
}

supabaseClient.channel("state")
  .on("postgres_changes",{event:"*",schema:"public",table:"state"},p=>{
    state=p.new.data;
    render(true); // realtime render
  }).subscribe();

/* ================= ACTIONS ================= */
function addContestant(){
  const n=contestantName.value.trim();
  const buy=parseAmount(contestantBuyIn.value)||0;
  if(!n||state.contestants[n]) return;

  state.contestants[n]={ total:0, bets:[], buyIn:buy };
  contestantName.value="";
  contestantBuyIn.value="";
  contestantName.focus();

  saveState();
}

function placeBet(){
  const c=contestantSelect.value;
  const amt=parseAmount(betAmount.value);
  const bettor=bettorName.value.trim();
  if(!c||!amt||!bettor) return;

  state.contestants[c].total+=amt;
  state.contestants[c].bets.push({ bettor, amount:amt });
  state.totalPot+=amt;

  bettorName.value="";
  betAmount.value="";
  bettorName.focus();

  saveState();
}

function toggleDetails(name){
  expandedContestant = expandedContestant === name ? null : name;
  render(false); // UI-only render
}

/* ================= RENDER ================= */
function render(fromRealtime=true){
  contestantSelect.innerHTML =
    Object.keys(state.contestants).map(n=>`<option>${n}</option>`).join("");

  contestantTable.innerHTML="";
  const payoutPool = state.totalPot*(1-BET_HOUSE);

  for(const [n,c] of Object.entries(state.contestants)){
    const mult=c.total?payoutPool/c.total:0;

    contestantTable.innerHTML+=`
      <tr class="clickable" onclick="toggleDetails('${n}')">
        <td>${n}</td>
        <td>${fmt(c.total)}</td>
        <td>${mult?mult.toFixed(2)+'x':'—'}</td>
        <td class="buyin-col">${fmt(c.buyIn)}</td>
      </tr>`;

    if(expandedContestant===n){
      contestantTable.innerHTML+=`
        <tr class="details">
          <td colspan="4">
            ${
              c.bets.length
                ? c.bets.map(b=>{
                    const payout=b.amount*mult;
                    return `${b.bettor}: ${fmt(b.amount)} → <strong>${fmt(payout)}</strong>`;
                  }).join("<br>")
                : "No bets placed"
            }
          </td>
        </tr>`;
    }
  }

  totalPot.textContent=fmt(state.totalPot);
  houseCut.textContent=fmt(state.totalPot*BET_HOUSE);
  payoutPool.textContent=fmt(payoutPool);

  if(IS_POPOUT){
    pageTitle.classList.add("popout-hide");
    addContestantCard.classList.add("popout-hide");
    placeBetCard.classList.add("popout-hide");
    totalsBlock.classList.add("popout-hide");
    document.querySelectorAll(".buyin-col").forEach(el=>el.classList.add("popout-hide"));
    overviewTitle.textContent=`Overview — Total Pot ${fmt(state.totalPot)}`;
  }
}

/* ================= INIT ================= */
loadState();

/* ================= ENTER SUPPORT ================= */
contestantName.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();addContestant();}});
contestantBuyIn.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();addContestant();}});
bettorName.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();placeBet();}});
betAmount.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();placeBet();}});
</script>

</body>
</html>
