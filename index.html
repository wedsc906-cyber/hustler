<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Betting Pool</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --bg:#0f172a; --panel:#020617; --border:#334155;
  --text:#e5e7eb; --muted:#94a3b8; --primary:#2563eb; --danger:#dc2626;
}

body {
  font-family: Inter, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: 20px;
}

/* ===== POOL GRID ===== */
.pool-controls { margin-bottom: 12px; }

.pool-grid {
  display: grid;
  gap: 16px;
}
.pool-grid.cols-1 { grid-template-columns: 1fr; }
.pool-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
.pool-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
.pool-grid.cols-4 { grid-template-columns: repeat(4, 1fr); }

.pool {
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 12px;
}

.pool-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* ===== ORIGINAL STYLES ===== */
.card {
  background: var(--panel);
  padding: 16px;
  border-radius: 12px;
  margin-top: 18px;
}

.controls {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

input, select, button {
  background: #020617;
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px;
  border-radius: 8px;
}

button { font-weight: 600; cursor: pointer; }
.btn-primary { background:#2563eb; color:white; }
.btn-secondary { background:#020617; border:1px solid var(--border); color:white; }
.btn-danger { background:#dc2626; color:white; }

table {
  width:100%;
  border-collapse: collapse;
  margin-top:10px;
}

th, td {
  padding:10px;
  border-bottom:1px solid var(--border);
  text-align:center;
}

.place-btn {
  background:#020617;
  border:1px solid var(--border);
  color:white;
  border-radius:8px;
}
.place-btn.active { background:#2563eb; }

.total { margin-top:6px; color:#94a3b8; }

.expand-btn {
  cursor: pointer;
  user-select: none;
  color: #94a3b8;
  margin-right: 6px;
  display: inline-block;
  transition: transform 0.15s ease;
}
.expand-btn.open { transform: rotate(90deg); }

.details-row { display: none; background: #020617; }
.details-cell { text-align: left; padding: 12px 16px; color: #cbd5f5; }

.remove-bet {
  margin-left: 8px;
  background: transparent;
  border: none;
  color: #f87171;
  cursor: pointer;
  font-size: 14px;
}

/* ================= POP-OUT MODE ================= */
.popout h1,
.popout .hide-in-popout,
.popout .place-col,
.popout .buyin-col {
  display: none !important;
}

.popout body { padding: 10px; }
.popout table { font-size: 18px; }
.popout .card .total { display: none; }
.popout .card { transform-origin: top center; }
</style>
</head>

<body>

<div class="pool-controls">
  <button class="btn-primary" onclick="addPool()">âž• Add Pool</button>
</div>

<div id="poolGrid" class="pool-grid cols-1"></div>

<template id="poolTemplate">
<div class="pool">
  <div class="pool-header">
    <h2>Pool</h2>
    <button class="btn-danger" onclick="deletePool(this)">âœ–</button>
  </div>

  <h1>Live Betting Pool</h1>

  <div class="card hide-in-popout">
    <h3>Add Contestant</h3>
    <div class="controls">
      <input id="contestantName">
      <input id="contestantBuyIn">
      <button class="btn-primary addContestantBtn">Add</button>
    </div>
  </div>

  <div class="card hide-in-popout">
    <h3>Place Bet</h3>
    <div class="controls">
      <input id="bettorName">
      <select id="contestantSelect"></select>
      <input id="betAmount">
      <button class="btn-primary placeBetBtn">Bet</button>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between">
      <h3 id="overviewTitle">Overview</h3>
      <div class="hide-in-popout">
        <button class="btn-secondary" onclick="openPopout()">ðŸ“º Pop-out</button>
        <button class="btn-danger" onclick="resetWithPassword()">Reset</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Contestant</th>
          <th>Total</th>
          <th>Mult</th>
          <th class="buyin-col">Buy-In</th>
          <th class="place-col">Place</th>
        </tr>
      </thead>
      <tbody id="contestantTable"></tbody>
    </table>

    <div class="total">Pot: <span id="totalPot">$0</span></div>
    <div class="total">House: <span id="houseCut">$0</span></div>
    <div class="total">Payout: <span id="payoutPool">$0</span></div>
  </div>

  <div class="card hide-in-popout">
    <h3>Buy-In Prize Pool</h3>
    <div>Total Buy-Ins: <span id="buyInTotal">$0</span></div>
    <div>Prize Pool: <span id="buyInPrize">$0</span></div>
    <hr>
    <div>ðŸ¥‡ <span id="firstName">â€”</span>: <span id="firstPrize">$0</span></div>
    <div>ðŸ¥ˆ <span id="secondName">â€”</span>: <span id="secondPrize">$0</span></div>
    <div>ðŸ¥‰ <span id="thirdName">â€”</span>: <span id="thirdPrize">$0</span></div>
  </div>
</div>
</template>

<script>
/* ================= POP-OUT DETECTION (RESTORED) ================= */
const isPopout = new URLSearchParams(location.search).has("popout");
if (isPopout) document.documentElement.classList.add("popout");

/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://ctirstrnatawigarrncc.supabase.co";
const SUPABASE_KEY = "sb_publishable_GdaFQ6Vn9HT-U9tg7iX8yw_810IiIXK";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= POOLS REALTIME SYNC ================= */
supabaseClient.channel("pools")
  .on(
    "postgres_changes",
    { event: "*", schema: "public", table: "pools" },
    () => {
      location.reload();
    }
  )
  .subscribe();

/* ================= POOL MANAGER ================= */
let poolCounter = 0;

function updateGridLayout() {
  const grid = document.getElementById("poolGrid");
  const count = grid.children.length;
  grid.className = "pool-grid cols-" + Math.min(Math.max(count,1),4);
}

async function addPool(fromDB = false) {

  const tpl = document.getElementById("poolTemplate");
  const pool = tpl.content.cloneNode(true).firstElementChild;
  const poolId = ++poolCounter;

  // âœ… persist pool definition
  if (!fromDB) {
  await supabaseClient.from("pools").insert({ id: poolId });
}

  pool.dataset.poolId = poolId;
  pool.querySelector("h2").textContent = `Pool ${poolId}`;
  document.getElementById("poolGrid").appendChild(pool);

  initPool(pool, poolId);
  updateGridLayout();
}


async function deletePool(btn) {
  const pool = btn.closest(".pool");
  const deletedId = Number(pool.dataset.poolId);

  // remove pool definition
  await supabaseClient.from("pools").delete().eq("id", deletedId);

  // remove pool state
  await supabaseClient.from("state").delete().eq("id", deletedId);

  // reindex pools table
  const { data } = await supabaseClient
    .from("pools")
    .select("id")
    .order("id");

  await supabaseClient.from("pools").delete().neq("id", -1);

  for (let i = 0; i < data.length; i++) {
    await supabaseClient.from("pools").insert({ id: i + 1 });
  }

  location.reload();
}



/* ================= ORIGINAL LOGIC (SCOPED) ================= */
function initPool(poolEl, poolId) {
  const $ = id => poolEl.querySelector(`#${id}`);

  const ADMIN_PASSWORD = "reset123";
  const BET_HOUSE = 0.15;
  const BUYIN_HOUSE = 0.10;

  let state = {
    contestants: {},
    totalPot: 0,
    placements: { first:null, second:null, third:null }
  };

  const parseAmount = v => {
    if (!v) return 0;
    const val = v.toLowerCase().trim();
    if (val.endsWith("m")) return parseFloat(val) * 1_000_000;
    if (val.endsWith("k")) return parseFloat(val) * 1_000;
    return parseFloat(val);
  };

  const fmt = v => `$${(v||0).toLocaleString()}`;
  const fmtPayout = v => `$${Math.floor(v||0).toLocaleString()}`;

  function scalePopoutToFit(){
    if(!isPopout) return;
    const card = poolEl.querySelector(".card");
    if(!card) return;
    card.style.transform = "scale(1)";
    const available = window.innerHeight - 20;
    const height = card.scrollHeight;
    if(height > available){
      card.style.transform = `scale(${available / height})`;
    }
  }

  async function saveState(){
    await supabaseClient.from("state")
      .upsert({ id: poolId, data:state }, { onConflict:"id" });
    render();
  }

  async function loadState(){
    const { data } = await supabaseClient
      .from("state").select("data").eq("id",poolId).single();
    if (data?.data) state = data.data;
    render();
  }

  supabaseClient.channel("state_"+poolId)
    .on("postgres_changes",{event:"*",schema:"public",table:"state",filter:`id=eq.${poolId}`},
      p => { state = p.new.data; render(); }
    ).subscribe();

  function addContestant(){
    const n = $("contestantName").value.trim();
    if(!n || state.contestants[n]) return;
    state.contestants[n] = { total:0, bets:[], buyIn: parseAmount($("contestantBuyIn").value) || 0 };
    $("contestantName").value=""; $("contestantBuyIn").value="";
    saveState();
  }

  function placeBet(){
    const c = $("contestantSelect").value;
    const amt = parseAmount($("betAmount").value);
    const bettor = $("bettorName").value.trim();
    if(!c || !amt || !bettor) return;

    state.contestants[c].total += amt;
    state.totalPot += amt;
    state.contestants[c].bets.push({ name: bettor, amount: amt });

    $("bettorName").value=""; $("betAmount").value="";
    saveState();
  }

  poolEl.querySelector(".addContestantBtn").onclick = addContestant;
  poolEl.querySelector(".placeBetBtn").onclick = placeBet;

  $("contestantName").addEventListener("keydown", e => e.key==="Enter" && addContestant());
  $("contestantBuyIn").addEventListener("keydown", e => e.key==="Enter" && addContestant());
  $("bettorName").addEventListener("keydown", e => e.key==="Enter" && placeBet());
  $("betAmount").addEventListener("keydown", e => e.key==="Enter" && placeBet());

  function render(){
    $("contestantSelect").innerHTML =
      Object.keys(state.contestants).map(n=>`<option>${n}</option>`).join("");

    $("contestantTable").innerHTML="";
    const payout = state.totalPot*(1-BET_HOUSE);
    let buyTotal=0;

    const sorted = Object.entries(state.contestants)
      .sort((a,b)=>(b[1].total||0)-(a[1].total||0));

    for(const [n,c] of sorted){
      buyTotal+=c.buyIn;
      const mult=c.total?payout/c.total:0;
      const rowId=`details_${poolId}_${n.replace(/\W/g,"")}`;

      const betsHtml = c.bets.length
        ? c.bets.map((b,i)=>`
          <div>
            ðŸ‘¤ ${b.name} â€” ${fmt(b.amount)}
            <span style="color:#22c55e;font-weight:600">â†’ ${fmtPayout(b.amount*mult)}</span>
            <button class="remove-bet" onclick="removeBet('${n}',${i})">ðŸ—‘</button>
          </div>`).join("")
        : "<div>No bets</div>";

      $("contestantTable").innerHTML+=`
        <tr>
          <td><span class="expand-btn" onclick="toggleRow('${rowId}',this)">â–¶</span>${n}</td>
          <td>${fmt(c.total)}</td>
          <td>${mult?mult.toFixed(2)+'x':'â€”'}</td>
          <td>${fmt(c.buyIn)}</td>
          <td>
            <button class="place-btn ${state.placements.first===n?'active':''}" onclick="setPlacement('first','${n}')">ðŸ¥‡</button>
            <button class="place-btn ${state.placements.second===n?'active':''}" onclick="setPlacement('second','${n}')">ðŸ¥ˆ</button>
            <button class="place-btn ${state.placements.third===n?'active':''}" onclick="setPlacement('third','${n}')">ðŸ¥‰</button>
          </td>
        </tr>
        <tr id="${rowId}" class="details-row">
          <td colspan="5" class="details-cell">${betsHtml}</td>
        </tr>`;
    }

    $("totalPot").textContent=fmt(state.totalPot);
    $("houseCut").textContent=fmt(state.totalPot*BET_HOUSE);
    $("payoutPool").textContent=fmt(payout);

    const prize=buyTotal*(1-BUYIN_HOUSE);
    $("buyInTotal").textContent=fmt(buyTotal);
    $("buyInPrize").textContent=fmt(prize);

    $("firstName").textContent=state.placements.first||"â€”";
    $("secondName").textContent=state.placements.second||"â€”";
    $("thirdName").textContent=state.placements.third||"â€”";
    $("firstPrize").textContent=fmt(prize*0.5);
    $("secondPrize").textContent=fmt(prize*0.3);
    $("thirdPrize").textContent=fmt(prize*0.2);

    scalePopoutToFit();
  }

  loadState();
}

/* ================= INIT POOLS FROM DB ================= */
(async function initPoolsFromDB(){
  const { data } = await supabaseClient
    .from("pools")
    .select("id")
    .order("id");

  // first-ever load
  if (!data || data.length === 0) {
    await supabaseClient.from("pools").insert({ id: 1 });
    addPool(true);
    return;
  }

  // rebuild pools from DB
  for (let i = 0; i < data.length; i++) {
  addPool(true);
}
})();

</script>

</body>
</html>
